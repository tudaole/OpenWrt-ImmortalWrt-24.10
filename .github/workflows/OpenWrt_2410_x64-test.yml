name: OpenWrt_2410_x64-test

on:
  workflow_dispatch:
  repository_dispatch:
    types: [on-update]

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_NAME: immortalwrt
  REPO_BRANCH: openwrt-24.10
  OpenWrt_VERSION: 24.10
  OpenWrt_ARCH: x86-64
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: immortalwrt/diy-part1-x64-test.sh
  DIY_P2_SH: immortalwrt/diy-part2-x64-test.sh
  FILE_NAME: OpenWrt_2410_x64-test
  TZ: Asia/Shanghai
  TELEGRAM_WORK_PUSH: true
  WECHAT_WORK_PUSH: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        run: |
          echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
          echo -e "------------------------------- CPUä¿¡æ¯ -------------------------------"
          echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
          echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
          echo -e "------------------------------- å†…å­˜ä¿¡æ¯ -------------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯: "
          sudo lshw -short -C memory | grep GiB
          echo -e "\n"
          echo -e "------------------------------- ç£ç›˜ä¿¡æ¯ -------------------------------"
          echo -e "ç£ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
          echo -e "------------------------------- ç£ç›˜è¯¦æƒ… -------------------------------"
          df -Th

      - name: æ¸…ç†ç£ç›˜ç©ºé—´ (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: æ£€æŸ¥ç£ç›˜æ£€ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT

      - name: å‡†å¤‡å®Œæˆ
        uses: actions/checkout@main

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "${TZ}"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: ä¸‹è½½å›ºä»¶æºç 
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone -b ${REPO_BRANCH} --single-branch --depth 1 ${REPO_URL} openwrt
          ln -sf /workdir/openwrt ${GITHUB_WORKSPACE}/openwrt

      - name: åŠ è½½è‡ªå®šä¹‰feeds
        run: |
          [ -e ${FEEDS_CONF} ] && mv ${FEEDS_CONF} openwrt/feeds.conf.default
          chmod +x ${DIY_P1_SH}
          cd openwrt
          ${GITHUB_WORKSPACE}/${DIY_P1_SH}

      - name: æ›´æ–°feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: å®‰è£…feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: ç”Ÿæˆé»˜è®¤é…ç½®
        run: cd openwrt && make defconfig
      
      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          chmod +x ${DIY_P2_SH}
          cd openwrt
          ${GITHUB_WORKSPACE}/${DIY_P2_SH}

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(($(nproc) + 1)) thread compile"
          make -j$(($(nproc) + 1)) V=s || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          echo "COMPILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT

      - name: åˆ—å‡ºå›ºä»¶æ–‡ä»¶
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          echo -e "------------------------------- æ–‡ä»¶åˆ—è¡¨ -------------------------------"
          ls
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: æ•´ç†å›ºä»¶
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cp -rf openwrt/.config ${{ env.FIRMWARE }}/config
          cd ${{ env.FIRMWARE }}
          rm -rf packages
          rm -rf *.buildinfo
          rm -rf profiles.json
          rm -rf immortalwrt-${{ env.OpenWrt_ARCH }}-generic-kernel.bin
          rm -rf immortalwrt-${{ env.OpenWrt_ARCH }}-generic.manifest
          rm -rf immortalwrt-${{ env.OpenWrt_ARCH }}-generic-squashfs-rootfs.img.gz
          rm -rf immortalwrt-${{ env.OpenWrt_ARCH }}-generic-rootfs.tar.gz
          mv immortalwrt-${{ env.OpenWrt_ARCH }}-generic-squashfs-combined-efi.img.gz immortalwrt-${{ env.OpenWrt_VERSION }}-${{ env.OpenWrt_ARCH }}-${{ env.FILE_NAME }}-efi-${{ env.COMPILE_DATE }}.img.gz
          echo -e "------------------------------- æ–‡ä»¶åˆ—è¡¨ -------------------------------"
          ls

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          echo "release_tag=${{ env.FILE_NAME }}" >> ${GITHUB_OUTPUT}
          touch release.txt
          echo "
          ğŸ’» æ¶æ„: ${{ env.OpenWrt_ARCH }}

          ğŸ“‚ æºç : ${{ env.REPO_URL }}

          ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}

          â±ï¸ ç¼–è¯‘æ—¶é—´: ${{ env.COMPILE_DATE }}

          ğŸŒ ç®¡ç†åœ°å€: 192.168.1.11 , å­ç½‘æ©ç : 255.255.255.0

          ğŸ‘¤ ç”¨æˆ·å: root

          ğŸ”’ å¯†ç : password 
          
          " > release.txt
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          tag_name: ${{ env.FILE_NAME }}
          token: ${{ secrets.GH_TOKEN }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: Telegram notification upload success
        if: steps.tag.outputs.status == 'success' && env.TELEGRAM_WORK_PUSH == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            â™¨ï¸ ã€${{ env.FILE_NAME }}ã€‘é¡¹ç›®ç¼–è¯‘å®Œæˆ â™¨ï¸            
            ğŸ’» æ¶æ„: ${{ env.OpenWrt_ARCH }}  
            ğŸ“‚ æºç : ${{ env.REPO_URL }}  
            ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}  
            â±ï¸ ç¼–è¯‘æ—¶é—´: ${{ env.COMPILE_DATE }}  
            ğŸŒ ç®¡ç†åœ°å€: 192.168.1.11 , å­ç½‘æ©ç : 255.255.255.0  
            ğŸ‘¤ ç”¨æˆ·å: root  
            ğŸ”’ å¯†ç : password             
            https://github.com/tudaole/OpenWrt-ImmortalWrt-24.10/releases/tag/${{ env.REPO_NAME }}_${{ env.OpenWrt_VERSION }}_${{ env.OpenWrt_ARCH }}
  
      - name: Enterprise WeChat notification upload success
        if: steps.tag.outputs.status == 'success' && env.WECHAT_WORK_PUSH == 'true'
        run: |
          curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${{ secrets.WEBHOOK_SEND_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{
              "msgtype": "news",
              "news": {
                "articles": [
                  {
                    "title": "â™¨ï¸ ã€${{ env.FILE_NAME }}ã€‘é¡¹ç›®ç¼–è¯‘å®Œæˆ â™¨ï¸",
                    "description": "- â€  å›ºä»¶åç§°ï¼š${{ env.FILE_NAME }}-${{ env.REPO_BRANCH }}\n
                      ğŸ’» æ¶æ„: ${{ env.OpenWrt_ARCH }}
            
                      ğŸ“‚ æºç : ${{ env.REPO_URL }}
            
                      ğŸŒ³ åˆ†æ”¯: ${{ env.REPO_BRANCH }}
            
                      â±ï¸ ç¼–è¯‘æ—¶é—´: ${{ env.COMPILE_DATE }}
            
                      ğŸŒ ç®¡ç†åœ°å€: 192.168.1.11 , å­ç½‘æ©ç : 255.255.255.0
            
                      ğŸ‘¤ ç”¨æˆ·å: root
            
                      ğŸ”’ å¯†ç : password 
                      
                    "url": "https://github.com/tudaole/OpenWrt-ImmortalWrt-24.10/releases/tag/${{ env.REPO_NAME }}_${{ env.OpenWrt_VERSION }}_${{ env.OpenWrt_ARCH }}"
                  }
                ]
              }
            }'
